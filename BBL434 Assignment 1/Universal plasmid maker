from Bio import SeqIO
from Bio.Seq import Seq
from Bio.SeqRecord import SeqRecord
import sys

def generate_universal_plasmid(input_fasta, design_file, output_fasta):
    """
    Time-efficient assembly of a Broad Host Range plasmid
    using a modular sequence library.
    """

    # 1. Load all DNA parts into a dictionary (O(N))
    parts_library = SeqIO.to_dict(SeqIO.parse(input_fasta, "fasta"))

    # 2. Essential Broad Host Range replication genes
    essential_backbone = ["oriV", "repA", "repB", "repC"]

    # Use list for efficient concatenation
    plasmid_parts = []

    # Add replication backbone (O(1) lookups)
    for gene in essential_backbone:
        if gene not in parts_library:
            raise ValueError(
                f"Essential replication gene '{gene}' missing in {input_fasta}"
            )
        plasmid_parts.append(parts_library[gene].seq)

    # 3. Parse Design.txt once (O(M))
    with open(design_file, "r") as f:
        for line in f:
            line = line.strip()

            if not line or line.startswith("*"):
                continue

            component_name = line.split(",")[0].strip()

            if component_name not in parts_library:
                raise ValueError(
                    f"Component '{component_name}' specified in Design.txt "
                    f"but not found in {input_fasta}"
                )

            plasmid_parts.append(parts_library[component_name].seq)

    # 4. Single efficient join (O(L))
    plasmid_seq = Seq("").join(plasmid_parts)

    # 5. Write output
    plasmid_record = SeqRecord(
        plasmid_seq,
        id="Universal_BHR_Plasmid",
        description="Broad host range plasmid assembled using repABC + oriV backbone"
    )

    SeqIO.write(plasmid_record, output_fasta, "fasta")
    print(f"Plasmid successfully generated: {output_fasta}")
