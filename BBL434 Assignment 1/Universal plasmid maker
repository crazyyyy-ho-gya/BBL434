#!/usr/bin/env python3
"""
Universal Plasmid Maker

Constructs a host-compatible plasmid from an arbitrary DNA sequence by:
1. Detecting the origin of replication (ORI) using GC skew analysis
2. Removing restriction enzyme recognition sites specified by the user
3. Ensuring the presence of required antibiotic / functional markers

"""

import sys
from Bio import SeqIO
from Bio.Seq import Seq
from Bio.SeqRecord import SeqRecord

# ==================================================
# Restriction enzyme recognition site database
# ==================================================
RESTRICTION_SITES = {
    "EcoRI": "GAATTC",
    "BamHI": "GGATCC",
    "HindIII": "AAGCTT",
    "NotI": "GCGGCCGC",
    "PstI": "CTGCAG",
    "XbaI": "TCTAGA",
    "KpnI": "GGTACC",
    "SalI": "GTCGAC",
    "SmaI": "CCCGGG"
}

# ==================================================
# Built-in canonical antibiotic resistance genes
# (Fallback library)
# ==================================================
DEFAULT_MARKERS = {
    "Ampicillin": (
        "ATGAGTATTCAACATTTCCGTGTCGCCCTTATTCCCTTTTTGCGGCATTTTGCCT"
        "TCCTGTTTTTGCTCACCCAGAAACGCTGGTGAAAGTAAAAGATGCTGAAGATCAG"
    ),
    "Kanamycin": (
        "ATGGATTGCACGCAGGTTCTCCGGCCGCTTGGGTGGAGAGGCTATTCGGCTATGA"
        "ACTGGGCGCGGAGAGCAGGCTGTTGGGTTGACGCGCTGCTGTTCTCGATCT"
    ),
    "Chloramphenicol": (
        "ATGGAGAAAAAAATCACTGGATATACCACCGTTGATATATCCCAATGGCATCGT"
        "AAAGAACATTTGAGGCATTTCAGTCAGTTGCTCAATGTACCTATAACCAGACCG"
    ),
    "Tetracycline": (
        "ATGACCGAGTACGAACTGGCCAGATGCTGATTTATCCGATGCGCGGATGGCTG"
    ),
    "Spectinomycin": (
        "ATGGATGCGATGTTGCGCTGGTTGACGAGATCCAGGCGATCGATG"
    ),
    "Hygromycin": (
        "ATGAAAAAGCCTGAACTCACCGCGACGTCTGTCGAGAAGTTT"
    ),
    "Zeocin": (
        "ATGGCCTCGCTGGCGCTGTTGGCGGCGGCTGCTGGAGG"
    )
}

# ==================================================
# Utility functions
# ==================================================
def load_genome(fasta_file: str) -> str:
    """Load genome sequence as uppercase string."""
    return str(SeqIO.read(fasta_file, "fasta").seq).upper()


def load_marker_library(marker_file: str) -> dict:
    """
    Load user-supplied markers from FASTA.
    Overrides built-in defaults if present.
    """
    markers = DEFAULT_MARKERS.copy()

    try:
        for record in SeqIO.parse(marker_file, "fasta"):
            markers[record.id] = str(record.seq).upper()
    except FileNotFoundError:
        print("[INFO] Marker file not found. Using built-in antibiotic library.")

    return markers


# ==================================================
# ORI detection via GC skew (O(n))
# ==================================================
def detect_ori(sequence: str, window: int = 1000, step: int = 200) -> str:
    """
    Identify origin of replication using minimum GC skew.
    """
    min_skew = float("inf")
    ori_index = 0

    for i in range(0, len(sequence) - window, step):
        window_seq = sequence[i:i + window]
        g = window_seq.count("G")
        c = window_seq.count("C")

        if g + c == 0:
            continue

        skew = (g - c) / (g + c)
        if skew < min_skew:
            min_skew = skew
            ori_index = i

    return sequence[ori_index:ori_index + window]


# ==================================================
# Design file parsing
# ==================================================
def parse_design_file(design_file: str):
    """
    Extract restriction enzymes and required markers.
    """
    enzymes = []
    markers = []

    with open(design_file) as f:
        for line in f:
            if line.strip():
                _, value = [x.strip() for x in line.split(",")]
                if value in RESTRICTION_SITES:
                    enzymes.append(value)
                else:
                    markers.append(value)

    return enzymes, markers


# ==================================================
# Core plasmid construction
# ==================================================
def construct_plasmid(
    genome: str,
    design_file: str,
    marker_file: str
) -> Seq:
    """
    Assemble final plasmid sequence.
    """
    ori = detect_ori(genome)
    enzymes, required_markers = parse_design_file(design_file)
    marker_library = load_marker_library(marker_file)

    # Remove restriction sites
    edited_genome = genome
    for enzyme in enzymes:
        edited_genome = edited_genome.replace(
            RESTRICTION_SITES[enzyme], ""
        )

    # Append missing markers
    additions = []
    for marker in required_markers:
        if marker in marker_library:
            if marker_library[marker] not in edited_genome:
                additions.append(marker_library[marker])
        else:
            print(
                f"[WARNING] Marker '{marker}' not found. "
                "Provide it via marker.fa"
            )

    return Seq(ori + edited_genome + "".join(additions))


# ==================================================
# Entry point
# ==================================================
def main():
    if len(sys.argv) != 6:
        print(
            "Usage:\n"
            "python universal_plasmid_maker.py "
            "Input.fa Design.txt marker.fa Output.fa"
        )
        sys.exit(1)

    input_fa, design_txt, marker_fa, output_fa = sys.argv[1:]

    genome = load_genome(input_fa)
    plasmid_seq = construct_plasmid(genome, design_txt, marker_fa)

    record = SeqRecord(
        plasmid_seq,
        id="Universal_Plasmid",
        description="Optimized host-compatible plasmid constructed automatically"
    )

    SeqIO.write(record, output_fa, "fasta")
    print("âœ… Plasmid successfully constructed")


if __name__ == "__main__":
    main()
